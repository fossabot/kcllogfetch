<?xml version="1.0" encoding="UTF-8"?>

<!-- アプリ再起動なしでXMLを読み込むようにする -->
<configuration scan="true" scanPeriod="60 seconds">

  <!-- ログ出力先ディレクトリ -->
  <property name="logDir" value="/Users/sim/log/" />
  <!-- APログのみ抽出し出力 -->
  <property name="apfileName" value="kcllog_aplog.log" />
  <!-- ログのタイムスタンプの形式を指定 -->
  <property name="format1" value="%d{yyyy/MM/dd HH:mm:ss.SSS} [%t] %-6p %c{10} %m%n" />
  
  <!-- shardsからvpcflowログのみ抽出し出力 -->
  <property name="vpcflowfileName" value="kcllogfetch_vpcflow.log" />
  <!-- shardsからcloudtrailログのみ抽出し出力 -->
  <property name="trailfileName" value="kcllogfetch_trail.log" />
  <!-- shardsからguraddutyログのみ抽出し出力 -->
  <property name="guarddutyfileName" value="kcllogfetch_guarddt.log" />


  <!-- KinesisClientが出力するAPログ -->
  <appender name="AP_FILE" class="ch.qos.logback.core.FileAppender">
    <filter class="ch.qos.logback.classic.filter.LevelFilter">
        <level>INFO</level>
        <onMatch>ACCEPT</onMatch>
	    <onMismatch>DENY</onMismatch>
    </filter>
    <file>${logDir}${apfileName}</file>
    <encoder>
      <pattern>${format1}</pattern>
    </encoder>
  </appender>
  
  <logger name="software.amazon">
    <appender-ref ref="AP_FILE" />
  </logger>
  <logger name="com.simosan.dynamodb.dynamoope">
    <appender-ref ref="AP_FILE" />
  </logger>


  <!-- Kinesisから取得したvpcflowログのみVPCLOG_FILEに指定したファイルに出力（APログ等は後続の定義で出力） -->
  <appender name="VPCLOG_FILE" class="ch.qos.logback.core.FileAppender">
    <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
        <evaluator>
          <matcher>
            <name>vpcflowlogMatcher</name>
            <regex>SimVPCFlowlog</regex>
          </matcher>
          <expression>vpcflowlogMatcher.matches(formattedMessage)</expression>
        </evaluator>
        <OnMismatch>DENY</OnMismatch> 
    </filter>
    <file>${logDir}${vpcflowfileName}</file>
    <encoder>
      <pattern>${format1}</pattern>
    </encoder>
  </appender>
  <logger name="com.simosan.kclapi.kcllogfetch.SimKinesisRecordProcessor" additivity="false">
    <appender-ref ref="VPCLOG_FILE" />
  </logger>

  <!-- Kinesisから取得したcloudtrailログのみCLOUDTRAIL_FILEに指定したファイルに出力（APログ等は後続の定義で出力） -->
  <appender name="CLOUDTRAIL_FILE" class="ch.qos.logback.core.FileAppender">
    <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
        <evaluator>
          <matcher>
            <name>cloudtrailMatcher</name>
            <regex>CloudTrail/DefaultLogGroup</regex>
          </matcher>
          <expression>cloudtrailMatcher.matches(formattedMessage)</expression>
        </evaluator>
        <OnMismatch>DENY</OnMismatch>
    </filter>
    <file>${logDir}${trailfileName}</file>
    <encoder>
      <pattern>${format1}</pattern>
    </encoder>
  </appender>
  <logger name="com.simosan.kclapi.kcllogfetch.SimKinesisRecordProcessor" additivity="false">
    <appender-ref ref="CLOUDTRAIL_FILE" />
  </logger>
    
  <!-- Kinesisから取得したguarddutyログのみGUARDDUTY_FILEに指定したファイルに出力（APログ等は後続の定義で出力） -->
  <appender name="GUARDDUTY_FILE" class="ch.qos.logback.core.FileAppender">
    <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
        <evaluator>
          <matcher>
            <name>guardDutyMatcher</name>
            <regex>/aws/events/guradduty</regex>
          </matcher>
          <expression>guardDutyMatcher.matches(formattedMessage)</expression>
        </evaluator>
        <OnMismatch>DENY</OnMismatch>
    </filter>
    <file>${logDir}${guarddutyfileName}</file>
    <encoder>
      <pattern>${format1}</pattern>
    </encoder>
  </appender>
  <logger name="com.simosan.kclapi.kcllogfetch.SimKinesisRecordProcessor" additivity="false">
    <appender-ref ref="GUARDDUTY_FILE" />
  </logger>
  
</configuration>